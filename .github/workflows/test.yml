name: Test Action - NPM

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-npm:
    name: Test with NPM
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    strategy:
      fail-fast: false
      matrix:
        node-version: ['22', '24']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Get old Nx version
        id: nx-version
        run: |
          # Get an older stable version of Nx for testing migration
          OLD_VERSION=$(npm view @nx/workspace versions --json | jq -r '.[]' | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -20 | head -1 || echo "19.0.0")
          echo "old-version=$OLD_VERSION" >> $GITHUB_OUTPUT
          echo "Using Nx version $OLD_VERSION for testing"

      - name: Create test Nx workspace
        run: |
          # Clean up any existing test workspace
          rm -rf test-workspace

          # Create a minimal test workspace
          mkdir test-workspace
          cd test-workspace

          # Create package.json first
          cat > package.json << EOF
          {
            "name": "test-workspace",
            "version": "1.0.0",
            "scripts": {
              "build": "echo 'Build complete'",
              "test": "echo 'Tests complete'"
            },
            "dependencies": {
              "@nx/workspace": "${{ steps.nx-version.outputs.old-version }}",
              "nx": "${{ steps.nx-version.outputs.old-version }}"
            }
          }
          EOF

          # Create nx.json
          cat > nx.json << EOF
          {
            "version": 3,
            "projects": {},
            "targetDefaults": {
              "build": {
                "cache": true
              }
            }
          }
          EOF

          # Install dependencies with npm
          npm install

          # Verify workspace setup
          echo "=== Workspace created successfully ==="
          ls -la
          cat package.json
          echo "=== End workspace info ==="

      - name: Configure Git for testing
        run: |
          git config --global user.name "nx-migrate-test-bot"
          git config --global user.email "nx-migrate-test-bot@users.noreply.github.com"

      - name: Test Action
        uses: ./
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          package-manager: npm
          working-directory: './test-workspace'
          dev-mode: 'true' # Enable dev mode for unique matrix branches
          skip-initial-install: 'true' # Skip since deps already installed in test setup

      - name: Verify outputs
        run: |
          echo "Action completed successfully"
          echo "Package manager: npm"
          echo "Node version: ${{ matrix.node-version }}"

  lint:
    name: Lint Action
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: action.yml
          config_file: .yamllint.yml

      - name: Validate action.yml
        run: |
          # Basic validation - check if action.yml is valid YAML and has required fields
          echo "Validating action.yml structure..."

          # Check if file exists
          if [[ ! -f "action.yml" ]]; then
            echo "❌ action.yml not found"
            exit 1
          fi

          # Check if it's valid YAML (already done by yamllint above)
          # Check for required fields
          if ! grep -q "^name:" action.yml; then
            echo "❌ Missing 'name' field in action.yml"
            exit 1
          fi

          if ! grep -q "^runs:" action.yml; then
            echo "❌ Missing 'runs' field in action.yml"
            exit 1
          fi

          echo "✅ action.yml validation passed"
